#!/bin/bash
# ================================================================
# æ–‡ä»¶å: go.3.sh
# ä¸­æ–‡å: é€‰é¡¹ 3 - æ¸…ç†ä¸´æ—¶æ–‡ä»¶
# åˆ›å»ºæ—¶é—´: 2025-01-15
# ================================================================
#
# ã€æ–‡ä»¶èŒè´£ã€‘
# æ¸…ç†æœåŠ¡å™¨ä¸Šçš„ä¸´æ—¶æ–‡ä»¶å’Œæ—¥å¿—
#
# ================================================================

step "æ¸…ç†ä¸´æ—¶æ–‡ä»¶"

# ============================================================
# 1. æ¸…ç†ä¸Šä¼ æ–‡ä»¶ï¼ˆ7å¤©å‰ï¼‰
# ============================================================

step "æ¸…ç† 7 å¤©å‰çš„ä¸Šä¼ æ–‡ä»¶..."
ssh ${SERVER_USER}@${SERVER_HOST} 'find /www/wwwroot/bem.it.sc.cn/api/uploads/ -mtime +7 -type f -delete 2>/dev/null'
success "ä¸Šä¼ æ–‡ä»¶æ¸…ç†å®Œæˆ"

# ============================================================
# 2. æ¸…ç†è¾“å‡ºæ–‡ä»¶ï¼ˆ7å¤©å‰ï¼‰
# ============================================================

step "æ¸…ç† 7 å¤©å‰çš„è¾“å‡ºæ–‡ä»¶..."
ssh ${SERVER_USER}@${SERVER_HOST} 'find /www/wwwroot/bem.it.sc.cn/api/outputs/ -mtime +7 -type f -delete 2>/dev/null'
success "è¾“å‡ºæ–‡ä»¶æ¸…ç†å®Œæˆ"

# ============================================================
# 3. æ¸…ç† PM2 æ—¥å¿—
# ============================================================

step "æ¸…ç† PM2 æ—¥å¿—..."
ssh ${SERVER_USER}@${SERVER_HOST} 'pm2 flush'
success "PM2 æ—¥å¿—æ¸…ç†å®Œæˆ"

# ============================================================
# 4. æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ
# ============================================================

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ’¾ æ¸…ç†åç£ç›˜ä½¿ç”¨æƒ…å†µ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
ssh ${SERVER_USER}@${SERVER_HOST} 'df -h /www/wwwroot/bem.it.sc.cn'

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“ ç›®å½•å¤§å°"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
ssh ${SERVER_USER}@${SERVER_HOST} 'du -sh /www/wwwroot/bem.it.sc.cn/api/uploads/ /www/wwwroot/bem.it.sc.cn/api/outputs/ 2>/dev/null'

echo ""
success "æ¸…ç†å®Œæˆ"
