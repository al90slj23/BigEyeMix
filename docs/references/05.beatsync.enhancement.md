# 节拍对齐与过渡增强功能

## 概述

为 BigEyeMix 实现了智能节拍对齐和过渡优化功能，增强音频拼接时的连接处理能力。

## 实现的功能

### 1. 节拍对齐服务 (BeatSyncService)

**文件**: `api/app/services/beat_sync_service.py`

**核心功能**:
- 使用 librosa 进行智能节拍检测
- 自动识别音频的 BPM (60-200 范围)
- 在节拍点进行精确对齐
- 根据 BPM 差异自动调整过渡长度
- 失败时自动降级到普通 crossfade

**主要方法**:
```python
async def sync_and_transition(audio1_path, audio2_path, transition_beats=4)
    # 检测两段音频的节拍
    # 找到最佳过渡点（强拍位置）
    # 执行节拍对齐的过渡
    # 返回处理后的音频和处理信息

def estimate_optimal_beats(tempo1, tempo2)
    # 根据 BPM 差异推荐过渡节拍数
    # BPM 接近: 2拍
    # BPM 中等差异: 4拍
    # BPM 差异大: 8拍
```

### 2. 过渡优化器 (TransitionOptimizer)

**文件**: `api/app/services/transition_optimizer.py`

**核心功能**:
- 分析两段音频的兼容性
- 提取音频特征（BPM、能量、频谱质心、零交叉率）
- 智能推荐最佳过渡方案
- 评估过渡效果的置信度

**主要方法**:
```python
async def analyze_compatibility(audio1_path, audio2_path, transition_type)
    # 分析指定过渡类型的兼容性
    # 返回兼容性、置信度、推荐方案

async def recommend_transition(audio1_path, audio2_path, user_preference=None)
    # 自动推荐最佳过渡方案
    # 比较 beatsync 和 crossfade 的效果
    # 返回最优方案和备选方案
```

### 3. API 端点

**文件**: `api/app/api/process.py`

新增的 API 端点:

#### POST `/api/beatsync/process`
执行节拍对齐过渡处理

**请求参数**:
```json
{
  "audio1_file_id": "file1.mp3",
  "audio1_start": 0,
  "audio1_end": 192,
  "audio2_file_id": "file2.mp3",
  "audio2_start": 0,
  "audio2_end": 116,
  "transition_beats": 4
}
```

**响应**:
```json
{
  "success": true,
  "output_id": "uuid.mp3",
  "sync_info": {
    "tempo1": 120.5,
    "tempo2": 118.3,
    "transition_duration": 2.0,
    "transition_beats": 4
  }
}
```

#### POST `/api/transition/analyze`
分析过渡兼容性

**参数**: `audio1_file_id`, `audio2_file_id`, `transition_type`

**响应**:
```json
{
  "success": true,
  "analysis": {
    "compatible": true,
    "confidence": 0.85,
    "recommendation": "beatsync",
    "reason": "BPM 较接近 (120.5 vs 118.3)",
    "optimal_beats": 4
  }
}
```

#### POST `/api/transition/recommend`
推荐最佳过渡方案

**参数**: `audio1_file_id`, `audio2_file_id`, `user_preference` (可选)

**响应**:
```json
{
  "success": true,
  "recommendation": {
    "recommendation": "beatsync",
    "confidence": 0.85,
    "reason": "BPM 较接近",
    "alternatives": [
      {
        "recommendation": "crossfade",
        "confidence": 0.70
      }
    ]
  }
}
```

### 4. 数据模型

**文件**: `api/app/models/schemas.py`

新增 `BeatSyncRequest` 模型:
```python
class BeatSyncRequest(BaseModel):
    audio1_file_id: str
    audio1_start: float
    audio1_end: float
    audio2_file_id: str
    audio2_start: float
    audio2_end: float
    transition_beats: int = 4  # 1-16拍
```

## 技术实现

### 节拍检测算法

使用 librosa 的 `beat_track` 函数:
1. 加载音频并降采样到 22050 Hz（提高处理速度）
2. 检测 BPM 和节拍帧位置
3. 将节拍帧转换为时间戳
4. 验证 BPM 合理性（60-200 范围）

### 过渡点选择

- **音频1**: 选择倒数第2个节拍（避免末尾静音）
- **音频2**: 选择第2个节拍（跳过开头静音）
- 确保过渡点在有效范围内

### 过渡执行

1. 在节拍点裁剪音频
2. 计算过渡时长 = (60 / 平均BPM) × 节拍数
3. 应用 crossfade 效果
4. 导出为 320k MP3

### 降级策略

当节拍检测失败时:
1. 捕获异常
2. 记录错误日志
3. 自动降级到普通 crossfade (3秒)
4. 返回降级信息

## 使用场景

### 1. 自动节拍对齐
适用于 BPM 接近的音乐片段，实现无缝拼接

### 2. 智能过渡推荐
系统自动分析音频特征，推荐最佳过渡方案

### 3. 手动节拍调整
用户可以指定过渡节拍数，系统自动计算时长

## 测试

运行测试脚本:
```bash
cd api
source venv/bin/activate
python test_beatsync.py
```

测试内容:
- 节拍检测功能
- BPM 识别准确性
- 兼容性分析
- 过渡推荐算法

## 性能优化

1. **音频降采样**: 22050 Hz（原始通常 44100 Hz）
2. **分析时长限制**: 只分析前 30 秒
3. **结果缓存**: AudioBuffer 缓存机制
4. **异步处理**: 所有 I/O 操作使用 async/await

## 未来增强

### 短期
- [ ] 前端集成：在时间线中显示 BPM 信息
- [ ] 实时预览：拖动过渡块时显示兼容性提示
- [ ] 批量处理：一次分析多个过渡点

### 长期
- [ ] 音乐风格识别：根据流派推荐过渡方案
- [ ] 自动 BPM 匹配：时间拉伸对齐不同 BPM
- [ ] 智能淡入淡出曲线：根据音频特征调整曲线

## 依赖项

已包含在 `requirements.txt`:
- librosa==0.10.1
- numpy==1.26.3
- scipy==1.11.4
- pydub==0.25.1

## 相关文件

- `api/app/services/beat_sync_service.py` - 节拍对齐服务
- `api/app/services/transition_optimizer.py` - 过渡优化器
- `api/app/api/process.py` - API 端点
- `api/app/models/schemas.py` - 数据模型
- `api/test_beatsync.py` - 测试脚本
- `docs/references/05.beatsync.enhancement.md` - 本文档
