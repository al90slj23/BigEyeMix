# 语音输入功能文档

## 概述

语音输入功能允许用户通过语音描述音频拼接需求，系统自动将语音转换为文字，然后由 AI 生成拼接方案。

## 技术架构

### 前端 (Muggle.voice.js)

**核心功能：**
- 录音控制（开始/停止）
- 音频数据采集（MediaRecorder API）
- 音频格式处理（webm/ogg/mp4）
- 文件上传到后端
- UI 状态管理

**录音参数：**
```javascript
{
    channelCount: 1,        // 单声道
    sampleRate: 16000,      // 16kHz 采样率
    echoCancellation: true, // 回声消除
    noiseSuppression: true  // 噪音抑制
}
```

**支持格式：**
- audio/webm（优先）
- audio/ogg（备选）
- audio/mp4（备选）

**文件限制：**
- 最小：1KB（防止录音时间过短）
- 最大：5MB（腾讯云 ASR 限制）

### 后端 (TencentASRService)

**服务提供商：** 腾讯云语音识别（ASR）

**API 版本：** 2019-06-14

**识别模型：** 16k_zh（16kHz 中文通用模型）

**支持格式：**
- wav (VoiceFormat=1)
- mp3 (VoiceFormat=3)
- m4a (VoiceFormat=4)
- flac (VoiceFormat=5)
- opus (VoiceFormat=6)
- amr (VoiceFormat=7)
- webm（自动转换）
- ogg（自动转换）

**签名算法：** TC3-HMAC-SHA256

## API 端点

### POST /api/asr/recognize

**请求：**
```
Content-Type: multipart/form-data
Body: audio file (max 5MB)
```

**响应：**
```json
{
    "success": true,
    "text": "识别的文字内容",
    "message": "识别成功"
}
```

**错误响应：**
```json
{
    "success": false,
    "text": "",
    "error": "错误信息",
    "message": "识别失败"
}
```

## 环境配置

在 `.env` 文件中配置腾讯云密钥：

```bash
# 腾讯云语音识别配置
TENCENT_SECRET_ID=your_tencent_secret_id
TENCENT_SECRET_KEY=your_tencent_secret_key
TENCENT_APP_ID=your_tencent_app_id
```

**获取密钥：**
1. 登录腾讯云控制台
2. 访问 [访问管理 - API密钥管理](https://console.cloud.tencent.com/cam/capi)
3. 创建或查看 SecretId 和 SecretKey
4. 开通语音识别服务并获取 AppId

## 用户交互流程

1. **点击麦克风按钮** → 请求麦克风权限
2. **开始录音** → 按钮变红色，显示脉冲动画
3. **再次点击** → 停止录音，显示"正在识别..."
4. **识别完成** → 文字自动填入输入框
5. **点击生成** → AI 分析并生成拼接方案

## UI 组件

### 麦克风按钮

**位置：** 麻瓜拼接输入框右侧

**状态：**
- 默认：珊瑚红渐变 (#ff6b6b → #ff8e53)
- 录音中：深红色 + 脉冲动画
- 处理中：禁用状态（灰色）

**图标：**
- 默认：`mic`（麦克风）
- 录音中：`mic-off`（停止录音）

### Toast 提示

**类型：**
- success：绿色背景
- error：红色背景
- info：蓝色背景

**显示时长：** 3秒

## 错误处理

### 浏览器兼容性

```javascript
if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    alert('您的浏览器不支持录音功能');
}
```

### 权限错误

- `NotAllowedError`：用户拒绝麦克风权限
- `NotFoundError`：未找到麦克风设备

### 录音质量检查

- 录音时间过短（< 1KB）：提示重新录制
- 文件过大（> 5MB）：提示缩短录音时间

### API 错误

- 未配置密钥：返回模拟响应，提示配置
- 网络错误：显示错误信息
- 识别失败：显示腾讯云返回的错误

## 集成说明

### 1. HTML 引入

```html
<!-- CSS -->
<link rel="stylesheet" href="/muggle/Muggle.voice.css?v=42">

<!-- JS -->
<script src="/muggle/Muggle.voice.js?v=42"></script>
```

### 2. 初始化

```javascript
// 在 Muggle.muggle.splice.js 中
function initMuggleSpliceFeatures() {
    initTimelineTabs();
    initMuggleSplice();
    
    // 初始化语音输入
    if (typeof initVoiceInput === 'function') {
        initVoiceInput();
    }
}
```

### 3. HTML 结构

```html
<div class="muggle-input-wrapper">
    <textarea id="muggleSpliceInput" class="muggle-input"></textarea>
    <button class="voice-input-btn" id="voiceInputBtn">
        <i data-lucide="mic"></i>
    </button>
</div>
```

## 性能优化

1. **音频压缩：** 使用 16kHz 采样率减少数据量
2. **格式选择：** 优先使用 webm 格式（压缩率高）
3. **流式上传：** 使用 FormData 直接上传 Blob
4. **错误降级：** API 不可用时提供友好提示

## 安全考虑

1. **文件大小限制：** 防止恶意上传大文件
2. **格式验证：** 仅允许音频格式
3. **密钥保护：** 密钥存储在服务器端，不暴露给前端
4. **HTTPS：** 麦克风权限需要 HTTPS 环境

## 测试建议

### 本地测试

```bash
# 启动后端
cd api && source venv/bin/activate
uvicorn main:app --reload --port 8000

# 启动前端（需要 HTTPS）
cd web && python3 -m http.server 8080
```

### 生产测试

1. 配置腾讯云密钥
2. 部署到 HTTPS 域名
3. 测试不同录音时长（1秒 ~ 60秒）
4. 测试不同浏览器（Chrome、Safari、Firefox）
5. 测试移动端（iOS、Android）

## 已知限制

1. **浏览器支持：** 需要支持 MediaRecorder API
2. **HTTPS 要求：** 麦克风权限需要安全上下文
3. **文件大小：** 腾讯云限制 5MB
4. **识别语言：** 当前仅支持中文
5. **网络依赖：** 需要稳定的网络连接

## 未来改进

1. 支持实时流式识别（降低延迟）
2. 支持多语言识别
3. 添加录音波形可视化
4. 支持录音暂停/继续
5. 添加录音时长显示
6. 支持本地音频文件上传识别
