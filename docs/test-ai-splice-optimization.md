# 麻瓜拼接 AI 优化测试报告

## 问题描述

用户反馈 AI 理解错误：

**用户输入：**
> "把第一段，音频，分成，1分钟，1分钟，1分钟这样的间隔，然后在每个中间都加入第二段音频"

**错误理解：**
- AI 生成：A1 完整 + 3s 静音 + B1 完整

**正确理解应该是：**
- 将 A1 分成多个 1 分钟片段
- 在每个片段之间插入 B1
- 拼接顺序：A1a(0~60s) + B1 + A1b(60~120s) + B1 + A1c(120~180s)

## 优化方案

### 1. 提示词增强

在 `api/app/api/muggle_splice.py` 的 `build_structured_prompt()` 函数中添加了两个新的示例场景：

#### 示例3 - 分段插入（重要）
```
用户："把第一段音频分成1分钟、1分钟、1分钟这样的间隔，然后在每个中间都加入第二段音频"

正确理解：
- 将A1分成多个1分钟片段：A1a(0~60s), A1b(60~120s), A1c(120~180s)
- 在每个A片段之间插入完整的B1
- 拼接顺序：A1a + B1 + A1b + B1 + A1c

正确输出：
{
  "explanation": "...",
  "instructions": [
    {"type": "clip", "trackId": "A", "clipId": "1", "customStart": 0, "customEnd": 60},
    {"type": "transition", "transitionType": "crossfade", "duration": 3},
    {"type": "clip", "trackId": "B", "clipId": "1"},
    {"type": "transition", "transitionType": "crossfade", "duration": 3},
    {"type": "clip", "trackId": "A", "clipId": "1", "customStart": 60, "customEnd": 120},
    {"type": "transition", "transitionType": "crossfade", "duration": 3},
    {"type": "clip", "trackId": "B", "clipId": "1"},
    {"type": "transition", "transitionType": "crossfade", "duration": 3},
    {"type": "clip", "trackId": "A", "clipId": "1", "customStart": 120, "customEnd": 180}
  ],
  "estimated_duration": 405.2
}
```

#### 示例4 - 分段插入（静音间隔）
```
用户："把第一段音频每隔30秒加入2秒静音"

正确理解：
- 将A1分成多个30秒片段
- 在每个片段之间插入2秒静音
- 拼接顺序：A1a(0~30s) + 2s静音 + A1b(30~60s) + 2s静音 + A1c(60~90s) + ...
```

### 2. 测试脚本

创建了两个测试脚本：

#### `api/test_ai_manual.py` - 手动测试脚本
- 实际调用 DeepSeek API
- 测试 5 个关键场景
- 格式化输出 AI 理解结果
- 生成 JSON 测试报告

**使用方法：**
```bash
# 在服务器上运行（需要激活 venv）
cd /www/wwwroot/bem.it.sc.cn/api
source venv/bin/activate
python3 test_ai_manual.py
```

#### `api/test_muggle_splice_ai.py` - 自动化测试框架
- 定义 6 个测试场景
- 详细的验证规则
- 自动化验证 AI 输出
- 生成详细的测试报告

**测试场景：**
1. 场景1：去掉中间某段
2. 场景2：完整拼接
3. 场景3：分段插入（关键场景）
4. 场景4：分段插入静音
5. 场景5：多段拼接
6. 场景6：重复片段

## 测试方法

### 方法1：Web 界面测试（推荐）

1. 访问 https://bem.it.sc.cn/muggle
2. 上传两个音频文件（建议使用项目中的测试文件）
3. 切换到"麻瓜拼接"标签
4. 测试以下输入：

**测试用例1：分段插入**
```
把第一段音频分成1分钟、1分钟、1分钟这样的间隔，然后在每个中间都加入第二段音频
```

**预期结果：**
- 生成 5 个片段指令（A1a, B1, A1b, B1, A1c）
- 生成 4 个过渡指令
- A 和 B 交替出现
- 每个 A 片段约 60 秒

**测试用例2：分段插入静音**
```
把第一段音频每隔30秒加入2秒静音
```

**预期结果：**
- 生成多个 30 秒的 A 片段
- 每个片段之间有 2 秒静音填充

**测试用例3：去掉中间某段**
```
《知我》1分56～2分34这一段不要，剩下的部分《知我》＋《春颂》（整段）
```

**预期结果：**
- 生成 3 个片段（A1前段 + A1后段 + B1）
- A1 被分成两段，中间部分被去掉

### 方法2：服务器端测试

```bash
# SSH 登录服务器
ssh root@bem.it.sc.cn

# 进入项目目录
cd /www/wwwroot/bem.it.sc.cn/api

# 激活虚拟环境
source venv/bin/activate

# 运行测试
python3 test_ai_manual.py

# 查看测试报告
cat test_ai_report.json
```

## 验证要点

### 1. 指令序列验证
- 检查 `instructions` 数组的顺序
- 确认 `clip` 和 `transition` 交替出现
- 不能有连续的 `transition`

### 2. 自定义时间范围验证
- 检查 `customStart` 和 `customEnd` 字段
- 确认时间范围符合用户描述
- 验证片段时长计算正确

### 3. 轨道交替验证（分段插入场景）
- 检查 `trackId` 是否交替（A-B-A-B）
- 确认不是简单的 A 完整 + B 完整

### 4. 总时长验证
- 检查 `estimated_duration` 是否合理
- 片段时长 + 填充时长 - 重叠时长 = 总时长

## 已知问题和限制

1. **AI 理解的不确定性**
   - AI 可能对相同输入产生不同输出
   - 需要多次测试验证稳定性

2. **自然语言的歧义性**
   - 用户描述可能不够精确
   - 需要提供更多示例引导 AI

3. **复杂场景的处理**
   - 超过 3 层嵌套的复杂逻辑可能理解错误
   - 建议用户分步描述

## 优化效果预期

通过添加详细的"分段插入"示例，AI 应该能够：

1. ✅ 正确识别"分段"关键词
2. ✅ 理解需要将一个音频分成多个片段
3. ✅ 理解需要在片段之间插入另一个音频
4. ✅ 生成正确的交替指令序列
5. ✅ 正确设置 `customStart` 和 `customEnd`

## 后续改进建议

1. **增加更多示例场景**
   - 复杂的多轨道拼接
   - 不等长片段分割
   - 条件性插入

2. **优化提示词结构**
   - 使用更清晰的分类
   - 添加反例说明
   - 强化关键规则

3. **实现智能纠错**
   - 检测常见错误模式
   - 自动修正明显错误
   - 提供用户友好的错误提示

4. **建立测试数据集**
   - 收集真实用户输入
   - 标注正确的理解结果
   - 持续优化提示词

## 部署信息

- **部署时间**: 2026-01-16
- **部署版本**: v43
- **修改文件**: 
  - `api/app/api/muggle_splice.py` (+46 行)
  - `api/test_ai_manual.py` (新增 233 行)
  - `api/test_muggle_splice_ai.py` (新增 384 行)
- **部署状态**: ✅ 已部署到生产环境
- **访问地址**: https://bem.it.sc.cn/muggle

## 测试清单

- [ ] 测试用例1：分段插入（关键）
- [ ] 测试用例2：分段插入静音
- [ ] 测试用例3：去掉中间某段
- [ ] 测试用例4：完整拼接
- [ ] 测试用例5：多段拼接
- [ ] 测试用例6：重复片段
- [ ] 验证生成的音频是否符合预期
- [ ] 检查波形显示是否正确
- [ ] 测试播放功能是否正常

---

**测试负责人**: 请在完成测试后更新此文档，记录实际测试结果和发现的问题。
