#!/bin/bash
# ================================================================
# æ–‡ä»¶å: go.0.sh
# ä¸­æ–‡å: é€‰é¡¹ 0 - æœ¬åœ°å¼€å‘
# åˆ›å»ºæ—¶é—´: 2025-01-15
# ================================================================
#
# ã€æ–‡ä»¶èŒè´£ã€‘
# å¯åŠ¨æœ¬åœ°å¼€å‘ç¯å¢ƒï¼ˆå‰ç«¯ + åç«¯ï¼‰
#
# ================================================================

step "å¯åŠ¨æœ¬åœ°å¼€å‘ç¯å¢ƒ"

# ============================================================
# 1. æ£€æŸ¥ç«¯å£
# ============================================================

if check_port 8000; then
    warn "ç«¯å£ 8000 å·²è¢«å ç”¨"
    if confirm "æ˜¯å¦é‡Šæ”¾ç«¯å£ 8000ï¼Ÿ"; then
        kill_port 8000
    else
        error "è¯·å…ˆé‡Šæ”¾ç«¯å£ 8000"
        exit 1
    fi
fi

if check_port 8080; then
    warn "ç«¯å£ 8080 å·²è¢«å ç”¨"
    if confirm "æ˜¯å¦é‡Šæ”¾ç«¯å£ 8080ï¼Ÿ"; then
        kill_port 8080
    else
        error "è¯·å…ˆé‡Šæ”¾ç«¯å£ 8080"
        exit 1
    fi
fi

# ============================================================
# 2. å¯åŠ¨åç«¯
# ============================================================

step "å¯åŠ¨åç«¯ API (ç«¯å£ 8000)..."

cd "$SCRIPT_DIR/api"

# æ£€æŸ¥è™šæ‹Ÿç¯å¢ƒ
if [ ! -d "venv" ]; then
    info "åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3.11 -m venv venv
    source venv/bin/activate
    pip install -r requirements.txt
else
    source venv/bin/activate
fi

# å¯åŠ¨åç«¯
python3.11 -m uvicorn main:app --reload --port 8000 &
BACKEND_PID=$!

cd "$SCRIPT_DIR"
success "åç«¯å·²å¯åŠ¨ (PID: $BACKEND_PID)"

# ============================================================
# 3. å¯åŠ¨å‰ç«¯
# ============================================================

step "å¯åŠ¨å‰ç«¯æœåŠ¡ (ç«¯å£ 8080)..."

cd "$SCRIPT_DIR/web"
python3 -m http.server 8080 &
FRONTEND_PID=$!

cd "$SCRIPT_DIR"
success "å‰ç«¯å·²å¯åŠ¨ (PID: $FRONTEND_PID)"

# ============================================================
# 4. æ˜¾ç¤ºè®¿é—®åœ°å€
# ============================================================

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
success "å¼€å‘ç¯å¢ƒå·²å¯åŠ¨ï¼"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "è®¿é—®åœ°å€ï¼š"
echo "  ğŸ  é¦–é¡µ: http://localhost:8080/home/"
echo "  ğŸ¯ éº»ç“œæ¨¡å¼: http://localhost:8080/muggle/"
echo "  ğŸ¨ å·«å¸ˆæ¨¡å¼: http://localhost:8080/wizard/"
echo "  ğŸ“š API æ–‡æ¡£: http://localhost:8000/docs"
echo ""
echo "æŒ‰ Ctrl+C åœæ­¢æœåŠ¡"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# ç­‰å¾…ç”¨æˆ·ä¸­æ–­
trap "kill $BACKEND_PID $FRONTEND_PID 2>/dev/null; success 'å·²åœæ­¢æ‰€æœ‰æœåŠ¡'; exit 0" INT TERM
wait
